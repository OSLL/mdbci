#!/usr/bin/env ruby

require 'getoptlong'

require_relative 'core/help'
require_relative 'core/generator'
require_relative 'core/session'
require_relative  'core/out'

#Reading options
opts = GetoptLong.new(
    ['--help', '-h', GetoptLong::NO_ARGUMENT],
    ['--template', '-t', GetoptLong::REQUIRED_ARGUMENT],
    ['--command', '-c', GetoptLong::REQUIRED_ARGUMENT],
    ['--override', '-w', GetoptLong::NO_ARGUMENT],
    ['--silent', '-s', GetoptLong::NO_ARGUMENT],
)

$session = Session.new
$session.configFile='instance.json'

$out = Out.new

opts.each do |opt, arg|
  case opt
    when '--template'
      p arg
      if arg != ''
        $session.configFile= arg
      end
      $out.info 'Using template name '+$session.configFile

    when '--help'
      Help.display
      exit
    when '--override'
      $session.isOverride =true
    when '--command'
      $session.command =arg
    when '--silent'
      $session.isSilent =true
    else
      $out.error 'Option are not supported:'+opt
  end
end

#Hello message
$out.info 'MariaDb CI CLI'

=begin
  run command (create config only for now)
=end

$session.checkConfig
$session.loadCollections

case ARGV.shift
  when 'show'
    $session.show(ARGV.shift)
  when 'sudo'
    $session.sudo(ARGV.shift)
  when 'setup'
    $session.setup(ARGV.shift)
  when 'generate'
    p $session
    $session.generate(ARGV.shift)
  else
    puts 'ERR: Something wrong with command line'
    Help.display
end


